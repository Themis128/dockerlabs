#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks (lenient mode)..."
echo "üí° Tip: Set HUSKY=0 to skip hooks, or use --no-verify to bypass"

# Allow skipping with environment variable
if [ "$SKIP_HOOKS" = "true" ] || [ "$HUSKY" = "0" ]; then
  echo "‚ö†Ô∏è  Skipping pre-commit checks (SKIP_HOOKS=true or HUSKY=0)"
  exit 0
fi

# Generate Nuxt types first (required for auto-imports)
echo "Generating Nuxt types..."
npx nuxi prepare 2>/dev/null || {
  echo "‚ö†Ô∏è  Warning: Failed to generate Nuxt types (non-blocking)"
  echo "üí° Tip: Run 'npm run dev' once to generate Nuxt types"
}

# Check if .nuxt/tsconfig.json exists (required for TypeScript to find auto-imports)
if [ -f ".nuxt/tsconfig.json" ]; then
  echo "Checking TypeScript (warnings allowed)..."
  npx vue-tsc --noEmit --skipLibCheck 2>&1 | tee /tmp/tsc-output.txt
  TSC_EXIT_CODE=$?

  # Only fail on actual errors, not warnings
  if [ $TSC_EXIT_CODE -ne 0 ]; then
    # Check if it's just warnings
    if grep -q "error TS" /tmp/tsc-output.txt; then
      echo "‚ö†Ô∏è  TypeScript errors found (non-blocking in lenient mode)"
      echo "üí° Review errors above, but commit will proceed"
    else
      echo "‚ö†Ô∏è  TypeScript check had issues (non-blocking)"
    fi
  fi
else
  echo "‚ö†Ô∏è  Skipping TypeScript check (.nuxt/tsconfig.json not found)"
  echo "üí° Tip: Run 'npm run dev' once to generate Nuxt types"
  echo "üí° This is normal if you haven't run the dev server yet"
fi

# Check Python syntax (non-blocking)
echo "Checking Python syntax (non-blocking)..."
python -m py_compile web-gui/server.py 2>/dev/null || {
  echo "‚ö†Ô∏è  Python syntax check failed (non-blocking)"
  echo "üí° Review Python errors, but commit will proceed"
}

# Check for common issues (non-blocking)
echo "Checking for common issues (non-blocking)..."
if git diff --cached --name-only | grep -q "\.json$"; then
  echo "Validating JSON files..."
  git diff --cached --name-only | grep "\.json$" | while read file; do
    python -m json.tool "$file" > /dev/null 2>&1 || {
      echo "‚ö†Ô∏è  Invalid JSON: $file (non-blocking)"
      echo "üí° Fix JSON syntax, but commit will proceed"
    }
  done
fi

# Ollama code quality analysis (only if speed score >= 90)
echo "Checking Ollama performance for pre-commit eligibility..."
if command -v tsx > /dev/null 2>&1; then
  # Test performance and check if speed score >= 90
  tsx scripts/code-quality/test-performance.ts > /tmp/ollama-perf-test.txt 2>&1
  PERF_EXIT_CODE=$?
  cat /tmp/ollama-perf-test.txt

  # If performance test passed (score >= 90), run pre-commit analysis
  if [ $PERF_EXIT_CODE -eq 0 ]; then
    echo ""
    echo "‚úÖ Ollama speed score >= 90 - Running code quality analysis..."
    if tsx scripts/code-quality/pre-commit-analyzer.ts; then
      echo "‚úÖ Ollama analysis passed"
    else
      echo "‚ùå Ollama analysis found issues"
      echo "‚ö†Ô∏è  Please fix issues before committing"
      exit 1
    fi
  else
    echo ""
    echo "‚ö†Ô∏è  Ollama speed score < 90 - Skipping analysis in pre-commit"
    echo "üí° Run 'npm run analyze:quality:test' to check performance"
    echo "üí° Or set ENABLE_OLLAMA_ANALYSIS=true to force enable (not recommended)"
  fi
else
  echo "‚ö†Ô∏è  tsx not found, skipping Ollama analysis"
  echo "üí° Install tsx: npm install -D tsx"
fi

echo "‚úÖ Pre-commit checks completed (lenient mode - warnings allowed)"
exit 0
